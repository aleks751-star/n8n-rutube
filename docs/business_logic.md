# YouTube → RuTube: бизнес-логика

## Цель
- Автоматическая миграция контента между связанными парами «YouTube‑канал → RuTube‑канал».
- Режимы синхронизации:
  1. **последнее** — перенос только новых публикаций.
  2. **архив** — импорт всей истории канала.

## Источники данных
- Настройки связок каналов и режимы миграции хранятся во внутреннем сервисе, из которого рабочие процессы получают задания.
- Форматы ссылок:
  - YouTube‑видео: `https://www.youtube.com/watch?v=<id>`
  - YouTube‑канал: `https://www.youtube.com/channel/<id>` или `https://www.youtube.com/@<alias>`
  - RuTube‑канал: `https://rutube.ru/channel/<id>`
  - RuTube‑ролик: `https://rutube.ru/video/<id>`

## Очереди и лимиты
- Все сетевые операции выполняются через TOR для обхода региональных ограничений.
- Интервалы между запросами:
  - скачивание: 5‑7 секунд;
  - загрузка: 10 секунд;
  - повторная попытка: 30 секунд.
- Суточные ограничения:
  - не более 100 роликов на канал;
  - не более 1000 запросов к каждому API.

## Обработка
- Названия и описания переводятся на русский язык.
- Видео скачиваются утилитой `yt-dlp` с флагами:
  - `--retries 10`;
  - `--write-info-json`;
  - `--write-thumbnail`;
  - `--restrict-filenames`.
- Ошибка 429 (Too Many Requests) вызывает паузу и повторную попытку.
- Контрольные суммы файлов используются для дедупликации.

## Публикация
- Обработанные файлы публикуются в целевой RuTube‑канал, соответствующий исходному каналу YouTube.
- Поля маппинга для RuTube:
  - `title` → `title`;
  - `description` → `description`;
  - `tags` → `tags`;
  - `thumbnail` → `preview`;
  - `visibility` → `is_hidden`.

## Статусы
- Все стадии обработки и публикации фиксируются в PostgreSQL.
- Возможные статусы задачи:
  1. `queued` — ожидание обработки;
  2. `downloading` — скачивание;
  3. `processing` — подготовка и перевод;
  4. `uploading` — загрузка на RuTube;
  5. `published` — публикация завершена;
  6. `skipped` — ролик уже существует;
  7. `failed` — ошибка, требуется вмешательство.

## Исключения
- Первая попытка скачивания выполняется напрямую. При ошибке или бане источник переключается на TOR и повторяется через `retry_download_interval`. После N неудачных попыток задача помечается статусом `failed`.
- Загрузка в RuTube следует аналогичной схеме: задержка между повторами составляет `retry_upload_interval`, количество попыток ограничено.
- Фатальные ошибки (например, превышен лимит или отсутствует ролик) помечаются `failed` и отражаются в отчётах.
- Все статусы и ошибки фиксируются в таблице очереди, системные исключения логируются для последующего анализа.

## Правила качества
- Не загружаются ролики с дублирующимся содержимым или неполными метаданными.
- После перевода текстов выполняется ручная проверка выборки для поддержания качества публикаций.
- Контрольная публикация первой партии роликов проводится вручную.
