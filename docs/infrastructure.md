# Инфраструктура проекта

## Среда
Проект развёрнут на виртуальном сервере под управлением Ubuntu 22.04. Используется Docker и Docker Compose: основной сервис `n8n` (версия 1.0+) работает в отдельном контейнере, рядом запускается `tor` для обхода блокировок. Compose‑файл описывает сеть и тома для постоянных данных.

## База данных (PostgreSQL)
Состояние workflow хранится в базе PostgreSQL 14. Схема `public` содержит основные таблицы:
- `admin_users` — аккаунты админки;
- `workflow_statuses` — статусы выполнения задач.
На ключевых полях определены индексы (`admin_users.email`, `workflow_statuses.workflow_id`) для ускорения выборок.

## Секреты и конфиг
Переменные окружения размещаются в файле `.env` в корне репозитория. Основные переменные:
- `POSTGRES_URL` — строка подключения к БД;
- `N8N_BASIC_AUTH_USER` и `N8N_BASIC_AUTH_PASSWORD` — доступ к интерфейсу;
- `TOR_SOCKS_PROXY` — адрес локального прокси;
- `N8N_ENCRYPTION_KEY` — ключ шифрования.

## Сети и доступ
Внешний трафик направляется через TOR Bridges. Сервис `n8n` доступен на порту `5678` во внутренней сети, наружу проксируется через HTTP‑прокси. Контейнер `tor` слушает порт `9050` для SOCKS‑соединений.

## Логи и мониторинг
Логи контейнеров доступны командой `docker logs`. Они дополнительно пишутся в каталог `/var/log/n8n` и ротируются утилитой `logrotate` раз в неделю. Алерты на критические ошибки отправляются в Telegram‑чат администраторов через встроенный workflow n8n.

## CI/CD
Каждый коммит проверяется GitHub Actions: выполняются `ruff` и `pytest`. В main попадают только pull‑requests после код‑ревью и успешного прохождения проверок. Деплой осуществляется автоматически при слиянии, обновляя контейнеры через `docker compose pull && docker compose up -d`.
